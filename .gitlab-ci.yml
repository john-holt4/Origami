# 1. Define all stages in order
stages:
  - build   # For building the container image
  - iso     # For generating the ISO (depends on build)
  - deploy  # For uploading the ISO (depends on iso)

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push"
      when: never
    - if: "$CI_COMMIT_TAG"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: "$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS"
      when: never
    - if: "$CI_COMMIT_BRANCH"

# 2. Template is updated to remove 'stage'. Each job will define its own.
.bluebuild-job-template:
  tags:
    - saas-linux-2xlarge-amd64
  image:
    name: ghcr.io/blue-build/cli
    entrypoint: [""]
  services:
    - docker:dind
  parallel:
    matrix:
      - RECIPE: "recipe-base.yml"
        ISO_NAME: "origami-x86_64.iso"
      - RECIPE: "recipe-nvidia.yml"
        ISO_NAME: "origami-nvidia-x86_64.iso"
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: /certs
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: $DOCKER_TLS_CERTDIR/client
  before_script:
    - curl --silent "https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer" | bash
    - export COSIGN_PRIVATE_KEY=$(cat .secure_files/cosign.key)
    - sleep 5

# 3. Job 1: Build the image in the 'build' stage
build-image:
  extends: .bluebuild-job-template
  stage: build
  script:
    - bluebuild build --verbose --rechunk --push ./recipes/$RECIPE

# 4. Job 2: Generate the ISO in the 'iso' stage (runs *after* build stage)
generate-iso:
  extends: .bluebuild-job-template
  stage: iso
  script:
    - bluebuild generate-iso --iso-name $ISO_NAME recipe ./recipes/$RECIPE
  # 5. Add 'artifacts' to save the ISO file for the next stage
  artifacts:
    paths:
      - $ISO_NAME # This saves the file (e.g., origami-x86_64.iso)
    expire_in: 1 hour

# 6. Job 3: Upload the saved ISO in the 'deploy' stage
upload-iso:
  stage: deploy
  image: amazon/aws-cli:latest # Use the official AWS CLI image
  # 7. We need the same matrix here to create a matching parallel job
  parallel:
    matrix:
      - RECIPE: "recipe-base.yml"
        ISO_NAME: "origami-x86_64.iso"
      - RECIPE: "recipe-nvidia.yml"
        ISO_NAME: "origami-nvidia-x86_64.iso"
  # 8. 'needs' connects this job to the matching 'generate-iso' job
  #    and tells it to download the artifact (the ISO)
  needs:
    - job: generate-iso
      artifacts: true
  variables:
    # Set the S3 endpoint URL for Cloudflare R2
    S3_ENDPOINT_URL: "https://0041560ce1f22c78111d98dfde401cac.r2.cloudflarestorage.com"
  script:
    # 9. Use the secure CI/CD variables you created
    - export AWS_ACCESS_KEY_ID=$S3_ACCESS_KEY
    - export AWS_SECRET_ACCESS_KEY=$S3_SECRET_KEY
    
    # 10. Upload the file
    - echo "Uploading $ISO_NAME to $S3_ENDPOINT_URL"
    - |
      aws s3 cp $ISO_NAME s3://origami-linux/$ISO_NAME \
        --endpoint-url $S3_ENDPOINT_URL