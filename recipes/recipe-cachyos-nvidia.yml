# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json

name: origami-linux-cachyos-nvidia

description: "EXPERIMENTAL: Origami Linux with CachyOS kernel and NVIDIA support. This is a testing variant - use at your own risk."

# This pulls the experimental CachyOS base image
base-image: ghcr.io/john-holt4/origami-linux-cachyos
image-version: latest

modules:
  # CachyOS kernel includes prebuilt nvidia-open modules, so we only need userspace components
  - type: dnf
    repos:
      cleanup: true
      files:
        - https://negativo17.org/repos/fedora-nvidia.repo
        - https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo
    install:
      packages:
        # NVIDIA userspace drivers and libraries
        - nvidia-driver
        - nvidia-driver-libs
        - nvidia-driver-cuda-libs
        - nvidia-settings
        - nvidia-persistenced
        - libva-nvidia-driver
        # Container support
        - nvidia-container-toolkit
        - libnvidia-container-tools

  # 2. Rebuild the initramfs to include the new drivers
  - type: initramfs

  # 3. Sign this new NVIDIA-specific image
  - type: signing