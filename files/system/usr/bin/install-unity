#!/usr/bin/env bash
set -e

# 1. Create the Ubuntu Container
# We use 22.04 (Jammy) as it is the stable LTS Unity targets.
echo "Folding (Installing) Unity Hub..."
# Check if box exists first to avoid errors
if ! distrobox list | grep -q "unity-box"; then
    distrobox create --name unity-box --image ubuntu:22.04 --nvidia
fi
rm ~/.local/share/applications/unity-box.desktop
# 2. Install Prerequisites
# Minimal Ubuntu containers don't have 'wget' or 'gpg' by default, so we install them first.
echo "Installing container prerequisites..."
distrobox enter unity-box -- sudo apt-get update
distrobox enter unity-box -- sudo apt-get install -y wget gpg sudo

# 3. Add Unity Signing Key (Your provided step)
echo "xh Adding Unity GPG Key..."
distrobox enter unity-box -- bash -c 'wget -qO - https://hub.unity3d.com/linux/keys/public | gpg --dearmor | sudo tee /usr/share/keyrings/Unity_Technologies_ApS.gpg > /dev/null'

# 4. Add Unity Repository (Your provided step)
echo "Adding Unity Repository..."
distrobox enter unity-box -- sudo sh -c 'echo "deb [signed-by=/usr/share/keyrings/Unity_Technologies_ApS.gpg] https://hub.unity3d.com/linux/repos/deb stable main" > /etc/apt/sources.list.d/unityhub.list'

# 5. Install Unity Hub
echo "Installing Unity Hub..."
distrobox enter unity-box -- sudo apt-get update
distrobox enter unity-box -- sudo apt-get install -y unityhub

# 6. Install Common Missing Dependencies for Editor
# Unity Editor often fails without these specific libs in a fresh container
distrobox enter unity-box -- sudo apt-get install -y libgconf-2-4 libglu1 libnss3 libasound2 libgtk-3-0

# 7. Export to Origami App Grid
echo "Exporting to App Grid..."
distrobox enter unity-box -- distrobox-export --app unityhub --export-label " (Origami Box)"

echo "Done! Launch 'Unity Hub (Origami Box)' from your menu."